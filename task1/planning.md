# Планирование: анализ, идентификация проблем и поиск решений

**Текущие и потенциальные проблемы:**
1. В текущей архитектуре статусная модель заказа распределена между CRM и MES,
что приводит к потере целостности бизнес-процесса. 
Очередь сообщений используется только как транспорт, без подтверждения приёмки и выполнения бизнес-действий.

2. Долгая загрузка Mes системы,
учитывая что пагинация и фильтрация не помогли, можно предположить,
что на фоне роста числа заказов и API-интеграций камнем преткновения становится высокая нагрузка на базу данных MES.. 
3. Добавление запросов с внешних апи еще сильнее увеличит нагрузку
на БД Mes.

**Предложения по устранению проблем:**

1. Ввести единую внешнюю статусную модель заказа, используемую CRM, 
онлайн-магазином и API-партнёрами. MES может использовать собственную внутреннюю модель, 
но обязан транслировать ключевые бизнес-события наружу.

2. Ввести подтверждение приёмки заказа MES и явные события об ошибках обработки, 
что позволит CRM контролировать жизненный цикл заказа и обнаруживать зависшие или потерянные заказы.

3. добавить на апи и бд контейнеры мониторинг:
мониторинг нагрузки на базу данных, rps, нагрузку на cpu, ram. 
4. Добавить трассировку на уровне всех приложений.
5. Добавить локальное in-memory кеширование на уровне API MES.
6. По результатам мониторинга при необходимости провести оптимизацию БД, в т.ч. партицирование, в крайнем случае шардирование.


**Целевая архитектура**
Через полгода система должна обеспечивать контролируемый жизненный цикл заказа и 
предсказуемую обработку заказов при росте нагрузки.

CRM является точкой контроля жизненного цикла заказа и работает с единой внешней статусной моделью,
которая используется онлайн-магазином и API-партнёрами.
MES отвечает за производственные этапы и использует собственную внутреннюю модель, 
но публикует ключевые бизнес-события во внешнюю систему.

Взаимодействие между CRM и MES построено таким образом, что создание заказа, 
его принятие в работу и ошибки обработки явно подтверждаются. Потерянные или зависшие заказы становятся обнаруживаемыми.

MES оптимизирован для работы операторов: снижена нагрузка на базу данных за счёт локального кеширования
и оптимизации read-запросов, внедрён базовый мониторинг.

Система оснащена минимально необходимыми средствами наблюдаемости, позволяющими выявлять проблемы до того,
как они начинают влиять на клиентов и партнёров.

**Предложения по порядку работ:**
В первую очередь необходимо стабилизировать жизненный цикл заказа:
ввести единую статусную модель и подтверждение приёмки заказов.
Параллельно следует внедрить базовый мониторинг и локальное кэширование для 
снижения нагрузки на MES и улучшения работы операторов.


Приоритетные инициативы:
Введение единой статусной модели и контроля жизненного цикла заказа -> устраняет потерю заказов и основные бизнес-жалобы.
Подтверждение приёмки заказов и обработка ошибок в интеграции CRM–MES -> повышает надёжность и доверие API-партнёров.
Базовый мониторинг и добавление кеширования MES -> улучшает работу операторов и снижает нагрузку при росте заказов.

Добавление распределённой трассировки и глубокая оптимизация БД (партицирование, шардирование) 
могут быть отложены до появления данных мониторинга и понимания реальных узких мест.