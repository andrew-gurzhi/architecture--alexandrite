# Выбор и настройка мониторинга в системе


**Мотивация**

На данный момент система частично мониторится через Яндекс Метрику, но после появления оформления заказов через API этих данных стало недостаточно.
Метрика хорошо показывает поведение пользователей сайта, но не даёт понимания, что происходит внутри системы: как работают API, где возникают задержки, теряются ли заказы, перегружается ли база данных или очередь сообщений.

С учётом текущих проблем (долгая загрузка MES, рост количества заказов и API-интеграций, риск потери заказов)
мониторинг необходим, чтобы:
понимать реальную нагрузку на сервисы и БД;
быстрее находить причины медленной работы MES;
обнаруживать ошибки и зависшие заказы;
иметь данные для принятия решений об оптимизации и масштабировании.

Без мониторинга дальнейшее развитие системы и оптимизация будут происходить «вслепую».

**Выбор подхода к мониторингу**

Для мониторинга системы предлагается использовать комбинацию двух подходов:
RED (Rate, Errors, Duration) — для API-сервисов (онлайн-магазин, CRM, MES).
USE (Utilization, Saturation, Errors) — для инфраструктурных компонентов (базы данных, RabbitMQ, контейнеры).

Такое разделение позволяет:
контролировать качество работы API с точки зрения клиентов и партнёров;
отслеживать перегрузки и узкие места на уровне инфраструктуры.

Мониторинг API (подход RED)
Rate (нагрузка)

Number of requests (RPS) for shop / CRM / MES API
Зачем: понимание общей нагрузки и её роста со временем.

Number of requests (RPS) per user
Зачем: выявление активности пользователей или партнёров.

Errors (ошибки)
Number of HTTP 500 for shop / CRM / MES API
Зачем: контроль стабильности сервисов и быстрая реакция на сбои.

Number of HTTP 200 for shop / CRM / MES API
Зачем: понимание соотношения успешных и ошибочных запросов.
Ярлыки: endpoint, httpMethod.

Duration (время ответа)

Response time (latency) for shop / CRM / MES API
Зачем: выявление медленных операций и деградации производительности, особенно для MES, с которым работают операторы.
Ярлыки: endpoint.

Мониторинг инфраструктуры (подход USE)
Utilization (утилизация)
CPU % и Memory Utilisation для shop / CRM / MES API
Зачем: понимание, хватает ли текущих ресурсов сервисам.

Memory Utilisation для shop db и MES db
Зачем: контроль состояния БД и риска деградации.

Saturation (насыщение)

Number of connections for shop db и MES db
Зачем: выявление ситуаций, когда база данных начинает «упираться» в лимиты соединений,
что может приводить к тормозам и ошибкам.

Number of messages in flight in RabbitMQ
Зачем: понимание, успевают ли потребители обрабатывать сообщения или очередь начинает накапливаться.

Errors (ошибки)

Number of dead-letter-exchange letters in RabbitMQ
Зачем: обнаружение сообщений, которые не были обработаны и потенциально приводят к потере заказов.

Дополнительные метрики
Size of shop db и MES db
Зачем: контроль роста данных и планирование оптимизации или масштабирования.

**Итог**

Предложенный набор метрик напрямую связан с текущими проблемами системы:
позволяет понять причины медленной работы MES;
снижает риск потери заказов;
даёт основу для принятия решений по кэшированию, оптимизации БД и масштабированию.


**План действий**
Для внедрения мониторинга в системе планируются следующие шаги:

Развернуть систему мониторинга - Prometheus для сбора метрик и Grafana для визуализации.

Подключить сбор инфраструктурных метрик:
Настроить сбор CPU, memory и network-метрик для сервисов shop API, CRM API и MES API, а также для баз данных.

Подключить сбор метрик API-сервисов:
Добавить сбор метрик RPS, latency и HTTP-ошибок (4xx/5xx) для всех API.

Настроить мониторинг RabbitMQ:
Добавить метрики количества сообщений в очередях, сообщений в обработке и сообщений в dead-letter очередях.

Создать базовые дашборды:
Подготовить дашборды состояния API, MES и очередей сообщений для оперативного контроля.

Настроить алерты и маршрутизацию уведомлений:
Настроить алерты на критические метрики (ошибки, задержки, saturation ресурсов).
Технические алерты направлять DevOps-инженеру и тимлиду на рабочую почту.
Бизнес-критичные алерты (риск потери заказов) дополнительно направлять продакт-менеджеру.