# Архитектурное решение по кешированию

**Мотивация**

В ходе анализа системы выявлено, что основная нагрузка в MES приходится на
частые read-запросы к базе данных при открытии первой страницы операторов
(дашборд заказов в работе по статусам).

Фильтрация и пагинация не привели к ожидаемому улучшению производительности.
При росте числа заказов и интеграций нагрузка на БД MES продолжает увеличиваться,
что негативно влияет на скорость работы операторов и время реакции системы.

Цель внедрения кеширования:
снизить нагрузку на базу данных MES;
ускорить загрузку первой страницы для операторов;
отложить сложную оптимизацию БД.(Глубокая оптимизация базы данных (индексация, партицирование, шардирование)
может быть выполнена позднее на основе данных мониторинга.)

В кеширование планируется включить данные, используемые для отображения
дашборда MES (списки заказов по статусам, используемые фильтры).

Предлагаемое решение

Для решения проблемы предлагается внедрить серверное локальное in-memory кеширование
на уровне API MES.

В качестве реализации может использоваться Caffeine.
Кеширование применяется только к read-операциям.

Выбран паттерн Cache-Aside:
при запросе данных API сначала проверяет наличие данных в кеше;
при отсутствии данных выполняется запрос к БД и результат сохраняется в кеш;
при изменении статуса заказа кеш инвалидируется или обновляется.

Данный паттерн выбран, так как:
не требует изменения логики записи данных;
минимизирует риски рассинхронизации;
позволяет гибко управлять временем жизни кеша.

**Процесс кеширования**

Сущности, участвующие в кешировании:
Оператор - Инициирует запрос на получение списка заказов на дашборде.
Продавец/Клиент - Инициирует запрос на изменение статуса заказа.
API MES - Основной компонент, который обрабатывает запросы от пользователей.
API Shop и CRM Api(компоненты с которыми взаимодействует клиент и продавец, и которые инициируют изменения статуса заказов)


Локальный in-memory кеш (Caffeine) - Хранит данные, необходимые для быстрого отображения дашборда:
списки заказов по статусам, фильтры и пагинацию.
TTL и максимальный размер кеша настраиваются в зависимости от объема данных и требований по свежести.

База данных MES
Источник данных при отсутствии записи в кеше.
Обновления статусов заказов инициируют обновление соответствующих кеш-записей.

Пошаговый процесс (Cache-Aside):
Оператор делает запрос к API MES на дашборд заказов.
API MES проверяет кеш:
Если данные есть -> возвращает данные из кеша.
Если данных нет -> выполняется запрос к БД.
Результат запроса сохраняется в кеш с заданным TTL.

При изменении статуса заказа API MES обновляет данные в базе данных и
инвалидирует соответствующие записи кеша.
Актуальные данные загружаются в кеш при следующем read-запросе.

Следующие запросы используют свежие данные из кеша.
```markdown
[Схема взаимодействия с кешированием](cache-scheme.drawio)
[Схема взаимодействия с кешированием (картинкой).png](cache-scheme.png)
```

**Стратегия инвалидации кеша**

В предлагаемом решении используется программная инвалидация кеша на основе изменений данных.

Кешированные данные инвалидируются при каждом изменении состояния заказа в MES DB
(создание заказа, изменение статуса, завершение обработки).

Обоснование выбора стратегии

Данный подход выбран по следующим причинам:

Для операторов критична актуальность данных — необходимо видеть самые новые заказы без задержек.
Статусы заказов меняются часто и напрямую влияют на содержимое дашборда.
Использование TTL может приводить к ситуации, когда данные формально валидны по времени, но уже устарели с точки зрения бизнеса.
Программная инвалидация позволяет гарантировать, что после изменения данных последующие запросы получают актуальное состояние.