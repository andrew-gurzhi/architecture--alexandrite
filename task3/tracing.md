# Архитектурное решение по трейсингу

**Мотивация**

В текущей архитектуре система состоит из нескольких приложений (онлайн-магазин, CRM, MES), взаимодействующих между собой асинхронно через RabbitMQ.
При росте нагрузки и появлении внешних API-партнёров увеличилось количество ситуаций, когда заказы обрабатываются дольше ожидаемого или «теряются» между системами.

Мониторинг позволяет понять, что система в целом работает нестабильно, однако не даёт ответа на вопрос, что происходит с конкретным заказом.
Трейсинг необходим для отслеживания полного пути заказа через все системы и выявления этапов, на которых он задерживается или обрывается.

Внедрение трейсинга позволит:
находить зависшие и потерянные заказы;
сокращать время диагностики инцидентов;
повысить прозрачность работы системы для поддержки и бизнеса;
снизить количество жалоб от клиентов и API-партнёров.
Метрики, на которые повлияет внедрение трейсинга

Технические:

Время полного прохождения заказа через систему (end-to-end latency).
Задержки между этапами обработки заказа (межсервисная latency).
Количество заказов, зависших между статусами.
Количество ошибок при асинхронной обработке заказов.

Бизнес-метрики:

Сокращение числа жалоб на «потерянные» и просроченные заказы.
Снижение времени реакции поддержки на обращения клиентов и партнёров.

**Предлагаемое решение**

Для распределённого трейсинга будет использоваться Jaeger.

Трейсинг внедряется на уровне приложений и их взаимодействий.
Системы, покрываемые трейсингом:
Онлайн-магазин
MES
CRM
Доступ к базам данных и хранилищам (Shop DB, 3D files storage) фиксируется в трассировке через сервисы, 
так что можно проследить все запросы и операции, даже без прямой интеграции в эти хранилища.


**Компромиссы**
Накладные расходы на производительность
Трассировка создаёт дополнительную нагрузку на сеть и хранилище данных. Для систем с высокой нагрузкой необходимо
применять sampling (выборочную трассировку) и использовать асинхронную отправку спанов, чтобы не блокировать
обработку запросов.

Сложности при работе с очередями (RabbitMQ, Kafka)
В Spring Boot микросервисах при асинхронной коммуникации через очереди спаны не передаются автоматически.
Чтобы сохранить контекст трассировки между отправителем и получателем сообщений,
требуется вручную оборачивать контекст в заголовки сообщений и извлекать его на стороне получателя.
Это добавляет дополнительную сложность реализации и требует контроля на всех этапах цепочки.

Безопасность и доступ
Трассировка может содержать чувствительные данные. Для предотвращения несанкционированного доступа планируется:
Аутентификация и авторизация: доступ в систему трейсинга получают сотрудники 
с актуальной учетной записью.

Шифрование данных при передаче и хранении.
Исключение или анонимизация конфиденциальной информации в спанах (пароли, токены, PII).

**Альтернативные решения**

При выборе инструмента распределённого трейсинга были рассмотрены альтернативные решения.

Dynatrace

Dynatrace — коммерческая платформа мониторинга и наблюдаемости, включающая распределённый трейсинг, метрики и логи.

Плюсы:
Автоматический трейсинг с минимальной донастройкой.
Удобный интерфейс и расширенная аналитика.
Единая система для мониторинга и трейсинга.

Минусы:
Платное решение с высокой стоимостью владения.
Избыточно для текущих задач проекта.
Проприетарное решение(vendor lock-in).

Вывод:
Dynatrace является мощным решением, однако для данной системы его использование
нецелесообразно из-за стоимости и избыточности функциональности.

**Zipkin**

Zipkin — open-source система распределённого трейсинга, часто используемая в Spring Boot приложениях.

Плюсы:

Простая интеграция.
Open-source и бесплатный.
Низкий порог входа.

Минусы:
Хуже масштабируется.
Меньше возможностей для сложных асинхронных сценариев.

Вывод:
Zipkin подходит для несложных сценариев и может быть использован в качестве альтернативы.
Однако с учётом асинхронного взаимодействия и потенциального роста нагрузки его возможности могут быть ограничены.

**Итоговый выбор**

В качестве решения для распределённого трейсинга рассматривались Jaeger и Zipkin как open-source инструменты,
способные покрыть базовые требования системы.
Оба решения позволяют реализовать распределённый трейсинг и интегрируются со Spring Boot микросервисами.
Однако в рамках текущей архитектуры выбор был сделан в пользу Jaeger по следующим причинам:
лучшая поддержка распределённых и асинхронных сценариев обработки;
более развитые возможности анализа длинных цепочек вызовов;
лучшая масштабируемость при росте объёма трассировочных данных.

При этом Zipkin остаётся допустимой альтернативой и может быть использован в 
случае меньшей нагрузки или упрощения архитектуры.
Выбор Jaeger сделан с учётом текущих требований и ожидаемого развития системы и может быть 
пересмотрен при изменении масштаба или характера нагрузки.